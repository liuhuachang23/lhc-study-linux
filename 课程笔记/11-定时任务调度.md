# 3.7定时任务调度

##  任务调度原理



任务调度:是指系统在某个时间执行的特定的命令或程序。

任务调度分类:

- 系统工作: 有些重要的工作必须周而复始地执行。如病毒扫描等

- 个别用户工作: 个别用户可能希望执行某些程序，比如对 mysql 数据库的备份。



## 1. crond任务调度

使用crontab进行定时任务调度  

![3.7定时调度原理](E:/Linux%E7%AC%94%E8%AE%B0/imgs/3/3.7%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86.jpg)



### 1) crontab使用

crontab [选项]

- -e：编辑crontab定时任务
- -i：查询crontab任务
- -r：删除当前用户所有的crontab任务
- -l：列出当前有哪些任务调度
- service crond restart：重启任务调度



### 2) cron表达式

| 项目      | 含义                 | 范围                    |
| --------- | -------------------- | ----------------------- |
| 第一个“*” | 一小时当中的第几分钟 | 0-59                    |
| 第二个“*” | 一天当中的第几小时   | 0-23                    |
| 第三个“*” | 一个月当中的第几天   | 1-31                    |
| 第四个“*” | 一年当中的第几月     | 1-12                    |
| 第五个“*” | 一周当中的星期几     | 0-7（0和7都代表星期日） |

**特殊符号说明**

`\*`:代表任何时间。比如第一个*就代表一小时中每分钟都执行一次的意思。

`,`:代表不连续的时间。比如“0 8,12,16 \* * *命令”，就代表在每天的8点0分，12点0分，16点0分都执行一次命令。

`-`:代表连续的时间范围。比如“0 5 * * 1-6命令”，代表在周一到周六的凌晨5点0分执行命令。

`/n`:代表每隔多久执行一次。比如“*/10 \* * * * 命令”，代表每隔10分钟就执行一遍命令。





### 3) 案例演示

```
#案例 1: 每隔 1分钟，就将当前的日期信息，追加到 /tmp/mydate 文件中
(1) crontab -e  										  				【编辑定时任务】
(2) */1 * * * * date >> /tmp/mydate 					 				【添加定时任务内容】

#案例 2: 每隔 1 分钟，将当前日期和日历都追加到 /home/mycal 文件中步骤:
(1) vim /home/my.sh 													【编写脚本】
(2) date >> /home/mycal 和 cal >> /home/mycal 						    【脚本内容】
(3) chmod u+x /home/my.sh 												【给 mysh 增加执行权限】   
(4) crontab -e   						 								【编辑定时任务】
(5) */1 * * * * /home/my.sh												【添加定时任务内容】

#案例 3: 每天凌晨 2:00 将 mysql 数据 testdb ，备份到文件中。
#提示: 指令为 mysqldump -u root -p密码 数据库 > /home/db.bak
(1) crontab -e															【编辑定时任务】
(2) 0 2 * * * mysqldump -u root -p1234567lhc testdb > /home/db.bak		【添加定时任务内容】
```









## 2. at任务调度

### 1) 基本介绍

- at 命令是一次性定时计划任务，at 的守护进程 atd 会以后台模式运行，检查作业队列来运行。

- 默认情况下，atd 守护进程每 60 秒检查作业队列，有作业时，会检查作业运行时间，如果时间与当前时间匹配，则运行此作业。 
- at 命令是一次性定时计划任务，执行完一个任务后不再执行此任务了
- 在使用 at 命令的时候，一定要保证 atd 进程的启动 ，可以使用相关指令 `ps -ef grep atd` 检测 atd 是否在运行

画一个示意图

![1674984141553](E:\Linux笔记\imgs\1\1674984141553.png)



### 2) at命令格式

`at[选项][时间]`

`Ctrl+D` 结束 at命令的输入，输出两次



### 3) at 命令选项

![1674987306691](E:\Linux笔记\imgs\1\1674987306691.png)



### 4) at 时间定义

1) 接受在当天的 hh:mm(小时:分钟式的时间指定。假如该时间已过去，那么就放在第二天执行。 例如: 04:00

2) 使用 midnight (深夜)，noon (中午) ，teatime (饮茶时间，一般是下午 4 点) 等比较模糊的词语来指定时间。

3) 采用 12 小时计时制，即在时间后面加上 AM(上午) 或 PM(下午) 来说明是上午还是下午。 例如: 12pm

4) 指定命令执行的具体日期，指定格式为 month day (月 日) 或 mm/dd/yy (月/日/年) 或 dd.mm.y(日.月.年)，指定的日期必须跟在指定时间的后面。 例如: 04:00 2021-03-1

5) 使用相对计时法。指定格式为: now + count time-units ，now 就是当前时间, time-units 是时间单位, 这里能够是 minutes(分钟)、hours(小时)、days(天)、weeks(星期)。count 是时间的数量,几天，几小时。 例如: now + 5 minutes

6)直接使用 today (今天) 、tomorrow (明天) 来指定完成命令的时间。



### 5) 应用实例

```
#案例1: 2天后的下午5点执行 /bin/ls /home
(1) at 5pm + 2 days
(2) /bin/ls /home  再Ctrl+D结束

#案例2: atq 命令来查看系统中没有执行的工作任务
[root@lhcCentOS01 home]# atq
1	Tue Jan 31 17:00:00 2023 a root
2	Tue Jan 31 17:00:00 2023 a root
3	Tue Jan 31 17:00:00 2023 a root

#案例3: 明天 17点钟，输出时间到指定文件内 比如 /root/date100.log
(1) at 5pm tomorrow
(2) /root/date100.log  再Ctrl+D结束

#案例4: 2分钟后，输出时间到指定文件内 比如 /root/date200.log
(1) at now + 2 minutes
(2) /root/date200.log  再Ctrl+D结束

#案例5: 删除已经设置的任务 atrm 编号
(1) atrm 4 【表示将job队列，编号为4的job删除】
```

